<!-- templates/edit_artwork.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit {{ artwork.title }} - Artfolio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>
<body>
    {% include 'navbar.html' %}
    <!-- 主要内容 -->
    <div class="container form-container">
        <!-- 页面标题 -->
        <div class="form-header">
            <h1 class="h3 mb-0">
                <i class="fas fa-edit text-primary"></i> Edit Artwork
            </h1>
            <p class="text-muted mb-0">
                Update your artwork details
            </p>
        </div>

        <!-- 当前作品预览 -->
        <div class="form-card">
            <h5 class="mb-3">Current Artwork</h5>
            <div class="row">
                <div class="col-md-4">
                    <img src="{{ artwork.image_url }}" alt="{{ artwork.title }}" class="current-image">
                </div>
                <div class="col-md-8">
                    <h4>{{ artwork.title }}</h4>
                    <p class="text-muted">{{ artwork.description }}</p>
                    <div class="d-flex gap-3 text-muted">
                        {% if artwork.medium %}
                        <span><i class="fas fa-brush"></i> {{ artwork.medium }}</span>
                        {% endif %}
                        {% if artwork.year %}
                        <span><i class="fas fa-calendar"></i> {{ artwork.year }}</span>
                        {% endif %}
                        {% if artwork.price %}
                        <span><i class="fas fa-tag"></i> ¥{{ artwork.price }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 表单 -->
        <form method="POST" enctype="multipart/form-data" id="artworkForm">
            <div class="form-card">
                <!-- 步骤指示器 -->
                <div class="step-indicator step-active">
                    <div class="step-number">1</div>
                    <span>Basic Information</span>
                </div>

                <!-- 标题 -->
                <div class="mb-3">
                    <label for="title" class="form-label">Title *</label>
                    <input type="text" class="form-control" id="title" name="title"
                           value="{{ artwork.title }}"
                           placeholder="Enter artwork title" required>
                </div>

                <!-- 图片URL -->
                <div class="mb-3">
                    <label for="image_url" class="form-label">Main Image URL *</label>
                    <input type="url" class="form-control" id="image_url" name="image_url"
                           value="{{ artwork.image_url }}"
                           placeholder="https://example.com/image.jpg" required>
                    <div class="form-text">Provide a direct link to your artwork image</div>
                    <!-- 图片预览 -->
                    <img id="imagePreview" class="preview-image" src="{{ artwork.image_url }}" alt="Image preview">
                </div>

                <!-- 描述 -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description *</label>
                    <textarea class="form-control" id="description" name="description" rows="4"
                              placeholder="Describe your artwork, inspiration, techniques used..." required>{{ artwork.description }}</textarea>
                </div>
            </div>

            <div class="form-card">
                <div class="step-indicator step-active">
                    <div class="step-number">2</div>
                    <span>Artwork Details</span>
                </div>

                <div class="row">
                    <!-- 媒介 -->
                    <div class="col-md-6 mb-3">
                        <label for="medium" class="form-label">Medium</label>
                        <select class="form-select" id="medium" name="medium">
                            <option value="">Select medium</option>
                            <option value="Oil Painting" {% if artwork.medium == 'Oil Painting' %}selected{% endif %}>Oil Painting</option>
                            <option value="Watercolor" {% if artwork.medium == 'Watercolor' %}selected{% endif %}>Watercolor</option>
                            <option value="Acrylic" {% if artwork.medium == 'Acrylic' %}selected{% endif %}>Acrylic</option>
                            <option value="Digital Art" {% if artwork.medium == 'Digital Art' %}selected{% endif %}>Digital Art</option>
                            <option value="Sculpture" {% if artwork.medium == 'Sculpture' %}selected{% endif %}>Sculpture</option>
                            <option value="Photography" {% if artwork.medium == 'Photography' %}selected{% endif %}>Photography</option>
                            <option value="Drawing" {% if artwork.medium == 'Drawing' %}selected{% endif %}>Drawing</option>
                            <option value="Mixed Media" {% if artwork.medium == 'Mixed Media' %}selected{% endif %}>Mixed Media</option>
                            <option value="Print" {% if artwork.medium == 'Print' %}selected{% endif %}>Print</option>
                            <option value="Other" {% if artwork.medium == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <!-- 年份 -->
                    <div class="col-md-6 mb-3">
                        <label for="year" class="form-label">Year</label>
                        <input type="number" class="form-control" id="year" name="year"
                               value="{{ artwork.year }}"
                               min="1900" max="2030"
                               placeholder="e.g., 2023">
                    </div>
                </div>

                <!-- 价格 -->
                <div class="mb-3">
                    <label for="price" class="form-label">Price (Optional)</label>
                    <div class="input-group">
                        <span class="input-group-text">¥</span>
                        <input type="number" class="form-control" id="price" name="price"
                               value="{{ artwork.price }}"
                               min="0" step="0.01"
                               placeholder="0.00">
                    </div>
                    <div class="form-text">Leave empty if not for sale</div>
                </div>

                <!-- 标签 -->
                <div class="mb-3">
                    <label for="tags" class="form-label">Tags</label>
                    <input type="text" class="form-control" id="tags"
                           placeholder="Enter tags separated by commas (e.g., landscape, abstract, portrait)">
                    <div class="form-text">Add relevant tags to help others discover your artwork</div>
                    <!-- 标签展示区域 -->
                    <div id="tagsContainer" class="mt-2">
                        {% if artwork.tags %}
                            {% for tag in artwork.tags %}
                                <span class="tag-badge">
                                    {{ tag }}
                                    <span class="remove-tag" data-tag="{{ tag }}">×</span>
                                </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="hidden" id="tagsInput" name="tags"
                           value="{{ artwork.tags|join(',') if artwork.tags }}">
                </div>
            </div>

            <div class="form-card">
                <div class="step-indicator">
                    <div class="step-number">3</div>
                    <span>Process Images (Optional)</span>
                </div>

                <!-- 创作过程图片 -->
                <div class="mb-3">
                    <label for="process_images" class="form-label">Process Images URLs</label>
                    <textarea class="form-control" id="process_images" name="process_images" rows="3"
                              placeholder="Enter URLs for process images, one per line">{% if artwork.process_images %}{{ artwork.process_images|join('\n') }}{% endif %}</textarea>
                    <div class="form-text">Add URLs showing your creative process (one URL per line)</div>

                    <!-- 过程图片预览 -->
                    <div id="processImagesPreview" class="image-preview-container mt-2">
                        {% if artwork.process_images %}
                            {% for process_image in artwork.process_images %}
                                <img src="{{ process_image }}" class="process-image-preview" alt="Process image {{ loop.index }}">
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 提交按钮 -->
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('artwork_detail', artwork_id=artwork._id) }}"
                   class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Cancel
                </a>
                <div>
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-save"></i> Update Artwork
                    </button>
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Delete Artwork</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete "{{ artwork.title }}"?</p>
                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{{ url_for('delete_artwork_route', artwork_id=artwork._id) }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger">Delete Artwork</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            // 图片URL预览
            $('#image_url').on('input', function() {
                const url = $(this).val();
                const preview = $('#imagePreview');

                if (url) {
                    preview.attr('src', url);
                }
            });

            // 标签管理
            $('#tags').on('keypress', function(e) {
                if (e.which === 13 || e.which === 44) { // Enter or comma
                    e.preventDefault();
                    addTag($(this).val().trim());
                    $(this).val('');
                }
            });

            function addTag(tagText) {
                if (!tagText) return;

                // 检查是否已存在
                if ($('#tagsContainer').find('.tag-badge:contains("' + tagText + '")').length > 0) {
                    return;
                }

                const tagHtml = `
                    <span class="tag-badge">
                        ${tagText}
                        <span class="remove-tag" data-tag="${tagText}">×</span>
                    </span>
                `;

                $('#tagsContainer').append(tagHtml);
                updateTagsInput();
            }

            // 移除标签
            $(document).on('click', '.remove-tag', function() {
                $(this).closest('.tag-badge').remove();
                updateTagsInput();
            });

            function updateTagsInput() {
                const tags = [];
                $('#tagsContainer .tag-badge').each(function() {
                    tags.push($(this).contents().filter(function() {
                        return this.nodeType === 3; // Text node
                    }).text().trim());
                });
                $('#tagsInput').val(tags.join(','));
            }

            // 过程图片URL预览
            $('#process_images').on('input', function() {
                const urls = $(this).val().split('\n').filter(url => url.trim());
                const container = $('#processImagesPreview');
                container.empty();

                urls.forEach(url => {
                    if (url.trim()) {
                        const img = $('<img>', {
                            class: 'process-image-preview',
                            src: url.trim(),
                            alt: 'Process image',
                            onerror: "this.style.display='none'"
                        });
                        container.append(img);
                    }
                });
            });

            // 表单提交验证
            $('#artworkForm').on('submit', function(e) {
                const title = $('#title').val().trim();
                const imageUrl = $('#image_url').val().trim();
                const description = $('#description').val().trim();

                if (!title) {
                    e.preventDefault();
                    alert('Please enter a title for your artwork');
                    $('#title').focus();
                    return;
                }

                if (!imageUrl) {
                    e.preventDefault();
                    alert('Please provide an image URL for your artwork');
                    $('#image_url').focus();
                    return;
                }

                if (!description) {
                    e.preventDefault();
                    alert('Please enter a description for your artwork');
                    $('#description').focus();
                    return;
                }

                // 显示提交中状态
                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Updating...');
            });

            // 搜索框回车提交
            $('input[name="q"]').keypress(function(e) {
                if (e.which === 13) {
                    $(this).closest('form').submit();
                }
            });

            // 初始化标签输入
            updateTagsInput();

            // 初始化过程图片预览
            $('#process_images').trigger('input');
        });
    </script>
</body>
</html>